name: CI - Secrets Scan + Security + Tests

on:
  push:
    branches:
      - main
  pull_request:

env:
  # You may set ACT to a default value if needed, or remove this block entirely if not used elsewhere
  ACT: false

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    continue-on-error: true  # ACT often fails due to missing artifacts runtime
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Gitleaks
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version || true

      - name: Run Gitleaks Scan
        run: |
          gitleaks detect \
            --source . \
            --no-git \
            --report-path gitleaks-report.json \
            --report-format json || true

      - name: Upload Gitleaks Report
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  trufflehog:
    runs-on: ubuntu-latest
    continue-on-error: true
    # ACT cannot handle job dependencies, so removed during ACT testing
    # GitHub version should re-enable:
    # needs: gitleaks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python + pip
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip

      - name: Install TruffleHog (pip version - ACT safe)
        run: |
          python3 -m pip install --upgrade pip
          pip3 install trufflehog || true
          trufflehog --version || true

      - name: Run TruffleHog filesystem scan
        run: |
          trufflehog filesystem --json . > trufflehog-report.json 2>/dev/null || true
          test -f trufflehog-report.json || echo "[]" > trufflehog-report.json

      - name: Upload TruffleHog Report
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-report.json

  tests:
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog]
    if: success()
    continue-on-error: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Bandit Security Scan (warn only)
        run: |
          bandit -r . -f json -o bandit-report.json || true

      - name: Upload Bandit Report
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

      - name: Run pytest
        run: pytest || true

  push_metrics:
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq & curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Count Gitleaks findings
        run: |
          count=$(jq length gitleaks-report.json 2>/dev/null || echo 0)
          echo $count > gitleaks_count.txt

      - name: Count TruffleHog findings
        run: |
          count=$(jq length trufflehog-report.json 2>/dev/null || echo 0)
          echo $count > trufflehog_count.txt

      - name: Push metrics to Pushgateway
        run: |
          curl --data-binary "gitleaks_secrets_found $(cat gitleaks_count.txt)" http://127.0.0.1:9091/metrics/job/ci || true
          curl --data-binary "trufflehog_secrets_found $(cat trufflehog_count.txt)" http://127.0.0.1:9091/metrics/job/ci || true

  deploy:
    runs-on: ubuntu-latest
    needs: push_metrics
    if: ${{ github.ref == 'refs/heads/main' && always() }}

    steps:
      - name: Stub Deployment
        run: echo "Deployment step would run here on GitHub only."
