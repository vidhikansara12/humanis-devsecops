name: CI - Secrets Scan + Security + Tests

on:
  push:
    branches:
      - main
  pull_request:

env:
  # You may set ACT to a default value if needed, or remove this block entirely if not used elsewhere
  ACT: false

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Gitleaks (ACT-safe)
        run: |
          curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest \
            | grep browser_download_url \
            | grep linux_x64.tar.gz \
            | cut -d '"' -f 4 \
            | wget -qi -
          tar -xzf gitleaks_*_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version || true

      - name: Run Gitleaks Scan
        run: |
          gitleaks detect \
            --source . \
            --no-git \
            --report-path gitleaks-report.json \
            --report-format json || true

      - name: Upload Gitleaks Report
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  trufflehog:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run TruffleHog (ACT Safe)
        uses: trufflesecurity/trufflehog@v3.54.0
        with:
          path: .
          args: --json

      - name: Ensure report exists (ACT quirk fix)
        run: |
          test -f trufflehog-results.json || echo "[]" > trufflehog-results.json
          mv trufflehog-results.json trufflehog-report.json

      - name: Upload TruffleHog Report
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-report.json

  tests:
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog]
    if: success()
    continue-on-error: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Bandit Security Scan (warn only)
        run: |
          bandit -r . -f json -o bandit-report.json || true

      - name: Upload Bandit Report
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

      - name: Run pytest
        run: pytest || true

  push_metrics:
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq & curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Count Gitleaks findings
        run: |
          count=$(jq length gitleaks-report.json 2>/dev/null || echo 0)
          echo $count > gitleaks_count.txt

      - name: Count TruffleHog findings
        run: |
          count=$(jq length trufflehog-report.json 2>/dev/null || echo 0)
          echo $count > trufflehog_count.txt

      - name: Push metrics to Pushgateway
        run: |
          curl --data-binary "gitleaks_secrets_found $(cat gitleaks_count.txt)" http://127.0.0.1:9091/metrics/job/ci || true
          curl --data-binary "trufflehog_secrets_found $(cat trufflehog_count.txt)" http://127.0.0.1:9091/metrics/job/ci || true

  deploy:
    runs-on: ubuntu-latest
    needs: push_metrics
    if: ${{ github.ref == 'refs/heads/main' && always() }}

    steps:
      - name: Stub Deployment
        run: echo "Deployment step would run here on GitHub only."
