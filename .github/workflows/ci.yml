name: CI - Secrets Scan + Security + Tests

on:
  push:
    branches:
      - main
  pull_request:

# ACT=true allows Pushgateway behavior locally
env:
  ACT: true


jobs:

  gitleaks:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Gitleaks (ACT-safe)
        run: |
          curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest \
            | grep browser_download_url \
            | grep linux_x64.tar.gz \
            | cut -d '"' -f 4 \
            | wget -qi -
          tar -xzf gitleaks_*_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version || true

      - name: Run Gitleaks Scan
        run: |
          gitleaks detect \
            --source . \
            --no-git \
            --report-path gitleaks-report.json \
            --report-format json || true

      - name: Upload Gitleaks Report (GitHub only)
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json



  trufflehog:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run TruffleHog (ACT-safe)
        uses: trufflesecurity/trufflehog@v3.54.0
        with:
          path: .
          extra_args: --json

      - name: Ensure report exists (ACT quirk fix)
        run: |
          if [ ! -f trufflehog-results.json ]; then
            echo "[]" > trufflehog-results.json
          fi
          mv trufflehog-results.json trufflehog-report.json

      - name: Upload TruffleHog Report (GitHub only)
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-report.json



  tests:
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit

      - name: Bandit Security Scan (warn only)
        run: |
          bandit -r . -f json -o bandit-report.json || true

      - name: Upload Bandit Report (GitHub only)
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

      - name: Run pytest
        run: pytest || true

  push_metrics:
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq & curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Count demo Gitleaks-style findings
        run: |
          # Count lines that look like secrets (from fake_secret.txt and others)
          if [ -f fake_secret.txt ]; then
            G=$(grep -Ei 'AWS_SECRET_ACCESS_KEY|PASSWORD|API_KEY|SECRET' fake_secret.txt | wc -l)
          else
            G=0
          fi

          echo "Gitleaks-style demo count: $G"
          echo $G > gitleaks_count.txt

      - name: Count demo TruffleHog-style findings
        run: |
          # Very naive "entropy-ish" demo: just count long-ish strings in fake_secret.txt
          if [ -f fake_secret.txt ]; then
            T=$(grep -E '.{20,}' fake_secret.txt | wc -l)
          else
            T=0
          fi

          echo "TruffleHog-style demo count: $T"
          echo $T > trufflehog_count.txt

      - name: Push metrics to Pushgateway (ACT only)
        if: env.ACT == 'true'
        run: |
          echo "Pushing metrics to local Pushgateway..."

          G=$(cat gitleaks_count.txt)
          T=$(cat trufflehog_count.txt)

          echo "gitleaks=$G"
          echo "trufflehog=$T"

          # Push with valid label pairs
          echo "gitleaks_secrets_found $G" \
            | curl -X PUT --data-binary @- http://localhost:9091/metrics/job/ci/instance/gitleaks

          echo "trufflehog_secrets_found $T" \
            | curl -X PUT --data-binary @- http://localhost:9091/metrics/job/ci/instance/trufflehog

          STATUS=1
          echo "pipeline_status $STATUS" \
            | curl -X PUT --data-binary @- http://localhost:9091/metrics/job/ci/instance/status

  deploy:
    runs-on: ubuntu-latest
    needs: push_metrics
    if: ${{ always() }}

    steps:
      - name: Stub Deployment
        run: echo "Deployment step would run here on GitHub only."
